{% load jformat %}
{% load analytical %}
{% load i18n static %}
{% load analytical %}

{% block header %}
    {% include "nakhll_market/parents/headermain.html" %}
{% endblock %}

    <title>بازار نخل | ویرایش حجره "{{UserShop.Title}}"</title>
    <link rel="stylesheet" href="{% static "css/cropper.css" %}">
{% analytical_head_bottom %}</head>

{% block headertag %}
    {% include "nakhll_market/parents/new-headertag-section.html" %}
{% endblock %}

{% block headersection %}
    {% include "nakhll_market/parents/menuheader-section.html" %}
{% endblock %}

<script type="text/javascript" charset="utf-8" src="{% static "js/chosen.jquery.js" %}"></script>

<div class="modal fade" id="complete-info-modal" data-keyboard="false" tabindex="-1" role="dialog" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title whole-prof-info-title" id="staticBackdropLabel">تکمیل اطلاعات حجره دار</h5>
          <button type="button" class="close right-close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body whole-prof-info-body">
            <div class="container whole-prof-info-form">
                <div class="row">
                    <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">
                        <p>برای ادامه روند ثبت حجره تکمیل اطلاعات پروفایل الزامی می باشد.</p>
                    </div>
                </div>
                <!--Empty Alerts-->
                <div id="alert-div-inputState-empty"></div>
                <div id="alert-div-inputBigCity-empty"></div>
                <div id="alert-div-inputCity-empty"></div>
                <div id="alert-div-inputPhoneNumber-empty"></div>
                <div id="alert-div-inputCityPerCode-empty"></div>
                <div id="alert-div-inputAddress-empty"></div>
                <div id="alert-div-inputZipCode-empty"></div>
                <div id="alert-div-image-newShop"></div>

                <!-- Char Alerts-->
                <div id="alert-div-inputState-Persian"></div>
                <div id="alert-div-inputBigCity-Persian"></div>
                <div id="alert-div-inputCity-Persian"></div>
                <div id="alert-div-inputPhoneNumber-digits"></div>
                <div id="alert-div-inputCityPerCode-digits"></div>
                <div id="alert-div-inputZipCode-digits"></div>

                <!--MinLength Alert-->
                <div id="alert-div-inputCityPerCode-minlength"></div>
                <div id="alert-div-inputAddress-minlength"></div>

                <!--Length Alerts-->
                <div id="alert-div-inputPhoneNumber-Length"></div>
                <div id="alert-div-inputZipCode-Length"></div>

                <label>
                    <h6>محدوده جغرافیایی</h6>
                </label>
                <i class="fal fa-info-circle shop-info tooltip-arrow" data-toggle="tooltip" data-placement="left"
                    title="نام استان، شهرستان و شهر خود را به صورت فارسی وارد نمایید."></i>
                    <div class="form-row">
                    <div class="form-group col-md-4">
                        <label for="inputshopState">استان <code>*</code></label>
                        <select name="Profile_State" class="chosen-select-rtl form-control choose-state-chosen" id="inputprofState">
                            <option value="0">استان خود را انتخاب نمائید...</option>
                            <option value="2">مرکزی</option>
                            <option value="3">خراسان شمالی</option>
                            <option value="4">گلستان</option>
                            <option value="5">قزوین</option>
                            <option value="6">قم</option>
                            <option value="7">اردبیل</option>
                            <option value="8">تهران</option>
                            <option value="9">هرمزگان</option>
                            <option value="10">یزد</option>
                            <option value="11">سمنان</option>
                            <option value="12">زنجان</option>
                            <option value="13">بوشهر</option>
                            <option value="14">کهگیلویه وبویراحمد</option>
                            <option value="15">ایلام</option>
                            <option value="16">خراسان جنوبی</option>
                            <option value="17">لرستان</option>
                            <option value="18">همدان</option>
                            <option value="19">کردستان</option>
                            <option value="20">سیستان وبلوچستان</option>
                            <option value="21">اصفهان</option>
                            <option value="22">خراسان رضوی</option>
                            <option value="23">کرمان</option>
                            <option value="24">فارس</option>
                            <option value="25">خوزستان</option>
                            <option value="26">کرمانشاه</option>
                            <option value="27">آذربایجان غربی</option>
                            <option value="28">آذربایجان شرقی</option>
                            <option value="29">مازندران</option>
                            <option value="30">گیلان</option>
                            <option value="31">چهارمحال وبختیاری</option>
                            <option value="32">البرز</option>
                        </select>
                    </div>
                    
                    <div class="form-group col-md-4">
                        <label for="inputshopBigCity">شهرستان <code>*</code></label>
                        <select name="Profile_BigCity" class="chosen-select-rtl form-control choose-bigcity-chosen" id="inputprofBigCity">
                            <option value="0">شهرستان خود را انتخاب نمائید...</option>
                        </select>
                    </div>
                    <div class="form-group col-md-4">
                        <label class="BigCitySelect" for="inputCityShop">شهر <code>*</code></label>
                        <select name="Profile_City" class="chosen-select-rtl form-control choose-city-chosen" id="inputprofCity">
                            <option value="0">شهر خود را انتخاب نمائید...</option>
                        </select>
                    </div>
                </div>
    
                <div class="form-row form-group">
                    <div class="form-group col-md-4">
                        <label for="inputPhoneNumber">تلفن ثابت <code>*</code></label>
                        <i class="fal fa-info-circle shop-info tooltip-arrow" data-toggle="tooltip" data-placement="left"
                            title="شماره تلفن ثابت شما باید 8 رقم باشد."></i>
                        <input value="{{request.user.User_Profile.PhoneNumber}}" type="number" placeholder="98****33"
                            name="Factor_PhoneNumber" pattern="[0-9]{8,8}" class="form-control" id="inputPhoneNumber">
                    </div>
                    <div class="form-group col-md-2">
                        <label for="inputCityPerCode">پیش شماره <code>*</code></label>
                        <i class="fal fa-info-circle shop-info tooltip-arrow" data-toggle="tooltip" data-placement="left"
                            title="پیش شماره شهر خود را به صورت اعداد وارد نمایید - پیش شماره شهر باید حداقل 3 رقم باشد."></i>
                        <input value="{{request.user.User_Profile.CityPerCode}}" type="number" placeholder="مثال : 034"
                            name="Factor_CityPerCode" pattern="[0-9]{3,3}" class="form-control" id="inputCityPerCode">
                    </div>
                </div>
    
                <div class="form-row form-group">
                    <div class="col-md-12">
                        <label for="inputAddress">آدرس <code>*</code></label>
                        <i class="fal fa-info-circle shop-info tooltip-arrow" data-toggle="tooltip" data-placement="left"
                            title="آدرس محل سکونت خود را وارد نمائید."></i>
                        <input value="{{request.user.User_Profile.Address}}" type="text"
                            placeholder="آدرس محل سکونت خود را وارد نمائید..."
                            name="Factor_Address" class="form-control" id="inputAddress" required>
                    </div>
                </div>
                <div class="form-row form-group">
                    <div class="col-md-6">
                        <label for="inputZipCode">کد پستی <code>*</code></label>
                        <i class="fal fa-info-circle shop-info tooltip-arrow" data-toggle="tooltip" data-placement="left"
                            title="کد پستی شما باید 10 رقم باشد."></i>
                        <input required value="{{request.user.User_Profile.ZipCode}}" type="number" placeholder="999*****76"
                            name="Factor_ZipCode" pattern="[0-9]{10,10}" class="form-control" id="inputZipCode">
                    </div>
                    <div class="col-md-6 prof-info-shop-btn">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">بستن</button>
                        <button id="send-profile-info-btn" type="button" class="btn btn-primary">ثبت اطلاعات</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
  </div>
</div>
<section id="bg-profile-top">

</section>

<section id="profile-sec">
    <div class="container">
        <div class="row">
            <div class="col-xl-3">
                <div class="profile-sidebar-site">    
                    {% block topsidebar %}
                        {% include "nakhll_market/profile/parents/new-topsidebar.html" %}
                    {% endblock %}
                    <div class="profile-sidebar-main">
                        <a href="/profile/dashboard/">
                            <button>
                                <i class="fas fa-id-badge"></i>
                                <h5>داشبورد</h5>
                            </button>
                        </a>

                        <a href="/profile/transaction/">
                            <button>
                                <i class="fad fa-clipboard-list"></i>
                            <h5>سفارشات</h5>
                            </button>
                        </a>

                        <a href="/profile/factor/">
                            <button>
                                <i class="fas fa-file-invoice-dollar"></i>
                                <h5>صورت حساب ها</h5>
                            </button>
                        </a>

                        <a href="/profile/ticketing/">
                            <button>
                                <i class="fad fa-user-headset"></i>
                                <h5>پشتیبانی</h5>
                            </button>
                        </a>

                        <a href="/profile/shops/">
                            <button class="activebtn">
                                <i class="fas fa-store"></i>
                                <h5>مدیریت حجره</h5>
                            </button>
                        </a>

                        <a href="/profile/review/">
                            <button>
                                <i class="fad fa-comments-alt"></i>
                                <h5>نقد ها و نظرات</h5>
                            </button>
                        </a>

                        {% if request.user.is_staff %}
                            {% block review %}
                                {% include "nakhll_market/profile/parents/menu_for_shop_manage.html" %}
                            {% endblock %}
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-xl-9">
                {% block header-profile %}
                    {% include "nakhll_market/profile/parents/new-header-profile.html" %}
                {% endblock %}

                <div class="alarm-section">
                    <div class="row">
                        {% if ShowAlart %}
                            <div class="col-xl-12 xol-lg-12 col-md-12 col-sm-12 col-12">
                                <div class="alert alert-warning alert-dismissible fade show custom-alart" role="alert">
                                    <i class="far fa-exclamation-circle"></i><strong>اطلاعیه</strong>
                                    <p>
                                        {{AlartMessage}}
                                    </p>
                                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                            </div>
                        {% endif %}
                    </div>

                    <div id="alert-div-inputshop-img-empty"></div>
                    <div id="alert-div-inputshop-title-empty"></div>
                    <div id="alert-div-inputshop-title-minlength"></div>
                    <div id="alert-div-inputshop-title-maxlength"></div>
                    <!-- <div id="alert-div-inputshop-title-valid-chars"></div> -->
                    <!-- <div id="alert-div-inputshop-title-persian"></div> -->
                    <!-- <div id="alert-div-inputshop-about-valid-chars"></div> -->
                    <div id="alert-div-inputshop-state-unknown"></div>
                    <div id="alert-div-inputshop-bigcity-unknown"></div>
                    <div id="alert-div-inputshop-city-unknown"></div>
                    <div id="alert-div-inputshop-Bio-maxlength"></div>
                    <!-- <div id="alert-div-inputshop-bio-valid-chars"></div> -->
                    <div id="alert-div-inputshop-submarket-unknown"></div>
                    <div id="alert-div-inputshop-submarket-limit-count"></div>
                    <div id="alert-div-inputshop-week-holidays-all"></div>
                    <div id="alert-div-system-error"></div>
                </div>

                <div class="row">
                    <div class="col-xl-12 col-lg-12 col-md-12 col-xs-12 col-12">
                        <div class="dashboard">
                            <h4>ویرایش حجره "{{UserShop.Title}}"</h4> 
                            <form id="edit-shop-form" method="POST" enctype="multipart/form-data" action="{% url "nakhll_market:Shop_Manager_EditShop" UserShop.Slug %}">
                                {% csrf_token %}
                                <div class="form-row">
                                    <div class="form-group col-md-6">
                                        <label for="inputshop_title">عنوان حجره</label>
                                        <i class="fal fa-info-circle shop-info tooltip-arrow" data-toggle="tooltip" data-placement="left" title="عنوان باید فارسی و حداکثر 70 کاراکتر باشد."></i>
                                        <input type="text" value="{{UserShop.Title}}" name="Shop_Title" class="form-control" id="inputshop_title" minlength="2" maxlength="70" required>
                                    </div>
                                    
                                    <div class="form-group col-md-6">
                                        <label for="inputslugshop">شناسه حجره</label>
                                        <i class="fal fa-info-circle shop-info tooltip-arrow" data-toggle="tooltip" data-placement="left" title='شناسه حجره باید شامل حروف انگلیسی کوچک، خط تیره ("-") و بدون فاصله باشد.'></i>
                                        <fieldset disabled>
                                            <input type="text" name="Shop_Slug" value="{{UserShop.Slug}}" class="form-control" id="inputslugshop" pattern="[a-z0-9\-_]{2,}" readonly>
                                        </fieldset>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="label cropper-label w-50" style="cursor: auto;">
                                        <label class="form-group col-md-12">
                                            <label for="inputslugshop">عکس حجره <code>*</code></label>
                                            <br>
                                            <a class="btn btn-primary choose-pic-btn">انتخاب عکس</a>
                                            <input type="file" class="sr-only input-pic-file" id="input" name="image" accept="image/*">
                                            <input type="text" class="form-control choose-pic-input-name choose-pic-input-hojre " disabled placeholder="آپلود عکس">
                                        </label>
                                        <br>
                                        {% if UserShop.Image_thumbnail_url %}
                                            <img class="rounded cropper-rounded " id="avatar" style="float:right;margin-right:3%" src="{{ UserShop.Image_thumbnail_url }}" alt="avatar" data-toggle="tooltip" title="انتخاب عکس ">

                                        {% else %}
                                             <img class="rounded cropper-rounded " id="avatar" style="float:left;margin-left:3%" src="{% static "images/image_upload.jpg" %}" alt="avatar" data-toggle="tooltip" title="انتخاب عکس ">

                                        {% endif %}
                                    </div>
                                    <div class="label cropper-label w-50" style="cursor: auto;">
                                        <label class="form-group col-md-12">
                                            <label for="inputslugshop">عکس کارت ملی <code>*</code></label>
                                            <br>
                                            <a class="btn btn-primary choose-pic-btn">انتخاب عکس</a>
                                            <input type="file" class="sr-only input-pic-file2" id="inputMeli" name="image" accept="image/*">
                                            <input type="text" class="form-control choose-pic-input-name choose-pic-input" disabled
                                                placeholder="آپلود عکس">
                                        </label>
                                        <br>
                                        {% if UserShop.Image_thumbnailMeli_url %}
                                        <img class="rounded cropper-rounded " id="avatarMeli" style="float:left;margin-left:3%" src="{{ UserShop.Image_thumbnailMeli_url }}" alt="avatar" data-toggle="tooltip" title="انتخاب عکس ">
                                        {% else %}
                                        <img class="rounded cropper-rounded " id="avatarMeli" style="float:left;margin-left:3%" src="{% static "images/image_upload.jpg" %}" alt="avatar" data-toggle="tooltip" title="انتخاب عکس ">
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="alert cropper-alert" role="alert"></div>
                                <div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true"
                                    data-keyboard="false" data-backdrop="static">
                                    <div class="modal-dialog modal-md" role="document">
                                        <div class="modal-content" style="width: 100%;">
                                            <div class="modal-header" style="box-shadow: 1px 5px 8px #d0cece;">
                                                <h5 class="modal-title" id="modalLabel">برش تصویر ...</h5>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"
                                                    style="border: 2px solid #ffffff;border-radius: 38px;box-shadow: 1px 3px 2px #a09090;">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body" style="padding:15px">
                                                <div class="img-container cropper-img-container">
                                                    <img id="image" src="https://avatars0.githubusercontent.com/u/3456749">
                                                </div>
                                            </div>
                                            <div class="modal-footer" id="modal-footer-err" style="box-shadow: 1px -2px 9px #e4e4e4;">
                                                <button type="button" class="btn btn-primary right-btn-send-modal" id="crop">انتخاب تصویر</button>
                                                <button type="button" class="btn btn-secondary " data-dismiss="modal">بستن</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                       
                                <div class="form-row">
                                    <div class="form-group col-md-12">
                                        <label for="inputshopdes">درباره حجره</label>
                                        <i class="fal fa-info-circle shop-info tooltip-arrow" data-toggle="tooltip" data-placement="left" title="حجره خود را به صورت کامل معرفی نمایید."></i>
                                        <textarea class="form-control" name="Shop_Des" id="inputshopdes" rows="2">{{UserShop.Description}}</textarea>
                                    </div>  
                                </div>
                                <br>
                                <form id="gallery-product-form">
                                    <h6>بارگذاری مدارک</h6>
                                
                                    <div class="row product-gallery-pics">
                                        <div class="plz-wait-gallery-pic">
                                            <div class="progress-hide-parent progress-hide">
                                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                                                    aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                            </div>
                                            <br>
                                            <div id="loaderDiv3">
                                                <div> لطفا منتظر بمانید </div> <img src="{% static "/images/loading.svg" %}" alt="در حال بارگذاری">
                                            </div>
                                        </div>
                                        {% if multiCropper.length > 0 %}
                                        {% for item in multiCropper %}
                                        <div class="col-xl-3 prod-gallery-pic-box">
                                            <div class="box-gallery-img-section">
                                                <label id="label-of-gallery" class="label cropper-label w-100">
                                                    <input type="file" class="sr-only" id="input3" name="image" accept="image/*">
                                                    <img class="rounded cropper-rounded gallery-newShop" style="float: none !important;" id="avatar3"
                                                        src="{% static "/images/loading.svg" %}" alt="avatar" data-toggle="tooltip"
                                                        title="انتخاب عکس ">
                                                </label>
                                            </div>
                                        </div>
                                        {% endfor %}
                                        {% else %}
                                        <div class="col-xl-3 prod-gallery-pic-box">
                                            <div class="box-gallery-img-section">
                                                <label id="label-of-gallery" class="label cropper-label w-100">
                                                    <input type="file" class="sr-only" id="input3" name="image" accept="image/*">
                                                    <img class="rounded cropper-rounded gallery-newShop" style="float: none !important;" id="avatar3"
                                                        src="{% static "/images/image_upload.jpg" %}" alt="avatar" data-toggle="tooltip" title="انتخاب عکس ">
                                                </label>
                                            </div>
                                        {% endif %}
                                        </div>
                                        <div class="alert cropper-alert" role="alert"></div>
                                        <div class="modal fade" id="modal2" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true"
                                            data-keyboard="false" data-backdrop="static">
                                            <div class="modal-dialog modal-md" role="document">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="modalLabel">برش تصویر ...</h5>
                                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                            <span aria-hidden="true">&times;</span>
                                                        </button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <div class="img-container cropper-img-container">
                                                            <img id="image3" src="https://avatars0.githubusercontent.com/u/3456749">
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer" id="modal-footer-err">
                                                        <button type="button" class="btn btn-primary right-btn-send-modal" id="crop3">انتخاب
                                                            تصویر</button>
                                                        <button type="button" class="btn btn-secondary " data-dismiss="modal">بستن</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                                
                                <div class="form-row shop-place-title">
                                    <h6>اطلاعات محل استقرار حجره</h6>
                                    <i class="fal fa-info-circle shop-info tooltip-arrow" data-toggle="tooltip" data-placement="left" title="اطلاعات دقیق محل استقرار حجره را وارد کنید."></i>
                                </div>

                                <div class="form-row">
                                    <div class="form-group col-md-6">
                                        <label for="inputshopState">استان <code>*</code></label>
                                        <select name="Shop_State" class="chosen-select-rtl form-control choose-state-chosen" id="inputshopState">
                                            <option value="0">استان خود را انتخاب نمائید...</option>
                                            <option value="2">مرکزی</option>
                                            <option value="3">خراسان شمالی</option>
                                            <option value="4">گلستان</option>
                                            <option value="5">قزوین</option>
                                            <option value="6">قم</option>
                                            <option value="7">اردبیل</option>
                                            <option value="8">تهران</option>
                                            <option value="9">هرمزگان</option>
                                            <option value="10">یزد</option>
                                            <option value="11">سمنان</option>
                                            <option value="12">زنجان</option>
                                            <option value="13">بوشهر</option>
                                            <option value="14">کهگیلویه وبویراحمد</option>
                                            <option value="15">ایلام</option>
                                            <option value="16">خراسان جنوبی</option>
                                            <option value="17">لرستان</option>
                                            <option value="18">همدان</option>
                                            <option value="19">کردستان</option>
                                            <option value="20">سیستان وبلوچستان</option>
                                            <option value="21">اصفهان</option>
                                            <option value="22">خراسان رضوی</option>
                                            <option value="23">کرمان</option>
                                            <option value="24">فارس</option>
                                            <option value="25">خوزستان</option>
                                            <option value="26">کرمانشاه</option>
                                            <option value="27">آذربایجان غربی</option>
                                            <option value="28">آذربایجان شرقی</option>
                                            <option value="29">مازندران</option>
                                            <option value="30">گیلان</option>
                                            <option value="31">چهارمحال وبختیاری</option>
                                            <option value="32">البرز</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group col-md-6 bigcity-form-group">
                                        <label for="inputshopBigCity">شهرستان <code>*</code></label>
                                        <div class="loading-chosen-ajax bigcity-loading"><img src="{% static "images/loading.svg" %}" alt="در حال بارگذاری">
                                            در حال بارگزاری
                                        </div>
                                        <select name="Shop_BigCity" class="chosen-select-rtl form-control choose-bigcity-chosen" id="inputshopBigCity">
                                            <option value="0">شهرستان خود را انتخاب نمائید...</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-row shop-place">
                                    <div class="form-group col-md-6 city-form-group">
                                        <label class="BigCitySelect" for="inputCityShop">شهر <code>*</code></label>
                                        <div class="loading-chosen-ajax city-loading"><img src="{% static "images/loading.svg" %}" alt="در حال بارگذاری">
                                            در حال بارگزاری
                                        </div>
                                        <select name="Shop_City" class="chosen-select-rtl form-control choose-city-chosen" id="inputshopCity">
                                            <option value="0">شهر خود را انتخاب نمائید...</option>
                                        </select>
                                    </div>
                                <script>
                                    var selectedState;
                                    createBigCity = function () { $.ajax (
                                        {
                                            type:'POST',
                                            url: '{% url "restapi:get_state_bigcity" %}',
                                            data: {
                                                id: selectedState,
                                                csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                                            },
                                            success: function (json) {
                                                $('#inputshopBigCity').empty(); //remove all child nodes
                                                $('#inputshopBigCity').append('<option value="0">شهرستان خود را انتخاب نمائید...</option>');
                                                for( i=0; i < json.length; i++) {
                                                    $("#inputshopBigCity").append('<option value="'+ json[i].id + '">' + json[i].name + '</option>');
                                                }
                                                $("#inputshopBigCity").prop('disabled', false);
                                                $(".bigcity-form-group").removeClass('select-wait');
                                                $(".bigcity-loading").hide();
                                                $("#inputshopBigCity").trigger("chosen:updated");
                                                if (findState)
                                                {
                                                    shopBigCityOptions = $('#inputshopBigCity option').map(function() { return ({'name': $(this).text(), 'id': $(this).val()})});
                                                    for(var i=0;i < shopBigCityOptions.length; i++)
                                                    {
                                                        if (usershopBigCity == shopBigCityOptions[i].name)
                                                        {
                                                            $("#inputshopBigCity").val(shopBigCityOptions[i].id);
                                                            $("#inputshopBigCity").trigger('chosen:updated');
                                                            selectedBigCity = shopBigCityOptions[i].id;
                                                            findBigCity = true;
                                                            createCity();
                                                            break;
                                                        }
                                                    }
                                                }
                                        },
                                        error: function () {
                                            
                                        }
                                    }
                                    )
                                }
                                var selectedBigCity;
                                        createCity = function () { $.ajax (
                                            {
                                                type:'POST',
                                                url: '{% url "restapi:get_bigcity_city" %}',
                                                data: {
                                                    id: selectedBigCity,
                                                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                                                },
                                                success: function (json) {
                                                    $('#inputshopCity').empty(); //remove all child nodes
                                                    $('#inputshopCity').append('<option value="0">شهر خود را انتخاب نمائید...</option>');
                                                    for( i=0; i < json.length; i++) {
                                                        $("#inputshopCity").append('<option value="'+ json[i].id + '">' + json[i].name + '</option>');
                                                    }
                                                    $("#inputshopCity").prop('disabled', false);
                                                    $(".city-form-group").removeClass('select-wait');
                                                    $(".city-loading").hide();
                                                    $("#inputshopCity").trigger("chosen:updated");
                                                    if (findBigCity)
                                                    {
                                                        shopCityOptions = $('#inputshopCity option').map(function() { return ({'name': $(this).text(), 'id': $(this).val()})});
                                                        for(var i=0;i < shopCityOptions.length; i++)
                                                        {
                                                            if (usershopCity == shopCityOptions[i].name)
                                                            {
                                                                $("#inputshopCity").val(shopCityOptions[i].id);
                                                                $("#inputshopCity").trigger('chosen:updated');
                                                                break;
                                                            }
                                                        }
                                                    }
                                            },
                                            error: function () {
                                                
                                            }
                                        }
                                        )
                                    }
                                $(document).ready( function () {
                                    $('#inputshopState').chosen().change(function() {
                                        $("#inputshopBigCity").prop('disabled', true);
                                        $("#inputshopBigCity").trigger("chosen:updated");
                                        $(".bigcity-form-group").addClass('select-wait');
                                        $(".bigcity-loading").show();
                                        selectedState = $(this).val();
                                        $('#inputshopCity').empty(); //remove all child nodes
                                        $('#inputshopCity').append('<option value="0">شهر خود را انتخاب نمائید...</option>');
                                        $("#inputshopCity").trigger("chosen:updated");
                                        if (selectedState != 0) {
                                            createBigCity();
                                        }
                                        else {
                                            $('#inputshopBigCity').empty(); //remove all child nodes
                                            $('#inputshopBigCity').append('<option value="0">شهرستان خود را انتخاب نمائید...</option>');
                                            $("#inputshopBigCity").prop('disabled', false);
                                            $(".bigcity-form-group").removeClass('select-wait');
                                            $(".bigcity-loading").hide();
                                            $("#inputshopBigCity").trigger("chosen:updated");
                                        }
                                    })
                                    $("#inputshopBigCity").chosen().change(function () {
                                        $("#inputshopCity").prop('disabled', true);
                                        $("#inputshopCity").trigger("chosen:updated");
                                        $(".city-form-group").addClass('select-wait');
                                        $(".city-loading").show();
                                        selectedBigCity = $(this).val();
                                        if (selectedBigCity != 0) {
                                            createCity();
                                        }
                                        else {
                                            $('#inputshopCity').empty(); //remove all child nodes
                                            $('#inputshopCity').append('<option value="0">شهر خود را انتخاب نمائید...</option>');
                                            $("#inputshopCity").prop('disabled', false);
                                            $(".city-form-group").removeClass('select-wait');
                                            $(".city-loading").hide();
                                            $("#inputshopCity").trigger("chosen:updated");
                                        }
                                    });
                            })
                                </script>
        
                                    <div class="form-group col-md-6">
                                        <label for="inputSubMarket">راسته حجره</label>
                                        <i class="fal fa-info-circle shop-info tooltip-arrow" data-toggle="tooltip" data-placement="left" title="حجره شما در کدام راسته ها قرار می گیرد؟
                                        در صورتی که راسته مورد نظر شما موجود نبود، این موضوع رو از طریق پیشتبانی سایت پیگیری نمایید."></i>
                                        <select data-placeholder="انتخاب راسته" multiple class="form-control submarket-shop" name="Shop_SubMarket" id="select-cat" tabindex="14">
                                            {% for item in Submarkets %}
                                                <option value="{{item.SubMarket.ID}}" {% if item.Status %}selected{% endif %}>{{item.SubMarket.Title}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group col-md-12">
                                    <label for="inputshopBio">معرفی حجره دار</label>
                                    <i class="fal fa-info-circle shop-info tooltip-arrow" data-toggle="tooltip" data-placement="left" title="متن کوتاهی با حداکثر 200 کاراکتر در مورد معرفی خودتان"></i>
                                        <textarea class="form-control" name="Shop_Bio" id="inputshopBio" maxlength="200" rows="2">{{UserShop.Bio}}</textarea>
                                    </div>  
                                </div>
                                <br>
                                <div class="form-row">
                                    <div class="form-group col-md-12 weekcheck">
                                        <label for="inputHolidays">روز های تعطیل</label>
                                        <i class="fal fa-info-circle shop-info tooltip-arrow" data-toggle="tooltip" data-placement="left" title="روز هایی که حجره شما فعالیت ندارد را وارد نمایید."></i>
                                        <br>
                                        <div class="row form-check form-check-inline">
                                            <div class="custom-control custom-checkbox">
                                                <input type="checkbox" class="custom-control-input" id="SATCheck" name="SATCheck" value="0" {% if '0' in UserShop.get_holidays %}checked{% endif %}>
                                                <label class="custom-control-label" for="SATCheck">شنبه</label>
                                            </div>
                                            <div class="custom-control custom-checkbox">
                                                <input type="checkbox" class="custom-control-input" id="SUNCheck" name="SUNCheck" value="1" {% if '1' in UserShop.get_holidays %}checked{% endif %}>
                                                <label class="custom-control-label" for="SUNCheck">یک شنبه</label>
                                            </div>
                                            <div class="custom-control custom-checkbox">
                                                <input type="checkbox" class="custom-control-input" id="MONCheck" name="MONCheck" value="2" {% if '2' in UserShop.get_holidays %}checked{% endif %}>
                                                <label class="custom-control-label" for="MONCheck">دو شنبه</label>
                                            </div>
                                            <div class="custom-control custom-checkbox">
                                                <input type="checkbox" class="custom-control-input" id="TUECheck" name="TUECheck" value="3" {% if '3' in UserShop.get_holidays %}checked{% endif %}>
                                                <label class="custom-control-label" for="TUECheck">سه شنبه</label>
                                            </div>
                                            <div class="custom-control custom-checkbox">
                                                <input type="checkbox" class="custom-control-input" id="WEDCheck" name="WEDCheck" value="4" {% if '4' in UserShop.get_holidays %}checked{% endif %}>
                                                <label class="custom-control-label" for="WEDCheck">چهار شنبه</label>
                                            </div>
                                            <div class="custom-control custom-checkbox">
                                                <input type="checkbox" class="custom-control-input" id="THUCheck" name="THUCheck" value="5" {% if '5' in UserShop.get_holidays %}checked{% endif %}>
                                                <label class="custom-control-label" for="THUCheck">پنج شنبه</label>
                                            </div>
                                            <div class="custom-control custom-checkbox">
                                                <input type="checkbox" class="custom-control-input" id="FRICheck" name="FRICheck" value="6" {% if '6' in UserShop.get_holidays %}checked{% endif %}>
                                                <label class="custom-control-label" for="FRICheck">جمعه</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <a class="btn btn-primary mr-auto edit-shop-btn shop-btn" id="send-left">ویرایش حجره</a>
                                <div class="clearfix"></div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>


<script src="{% static "js/cropper.js" %}"></script>
<script>

        var $progress;
            var $progressBar;
            var $alert;
            var initialAvatarURL;

            var form_Data = new FormData();;
            window.addEventListener('DOMContentLoaded', function () {

                var avatar = document.getElementById('avatar');
                var avatarMeli = document.getElementById('avatarMeli');
                var image = document.getElementById('image');
                var input = document.getElementById('input');
                var checkActiveCrop = null;
                var nameImage = '';
                var inputMeli = document.getElementById('inputMeli');
                $progress = $('.progress');
                $progressBar = $('.progress-bar');
                $alert = $('.cropper-alert');
                var $modal = $('#modal');
                var cropper;
                
                $('[data-toggle="tooltip"]').tooltip();

                input.onchange = (e) => {
                    // console.log('e.target.value===========>', e.target.files[0])
                    // debugger
                    checkActiveCrop = avatar;
                    nameImage = 'shop_image';
                    //   form_Data = new FormData();
                    form_Data.delete(nameImage);
                    var files = e.target.files;
                    var done = function (url) {
                          input.value = '';
                        image.src = url;
                        $alert.hide();
                        $modal.modal('show');
                    };
                    var reader, file, url;

                     if (files && files.length > 0) {
                        file = files[0];
                        if (URL) {
                            // console.log('URL==>', URL.createObjectURL(file))
                            done(URL.createObjectURL(file));
                        } else if (FileReader) {
                            reader = new FileReader();
                            reader.onload = function (e) {
                                done(reader.result);
                            };
                            reader.readAsDataURL(file);
                        }
                    }
                };

                inputMeli.onchange = (e)=> {
                    // debugger
                    checkActiveCrop = avatarMeli;
                    nameImage = 'shop_imageNation';
                    // form_Data = new FormData();
                    form_Data.delete(nameImage);
                    var files = e.target.files;
                    var done = function (url) {
                        inputMeli.value = '';
                        image.src = url;
                        $alert.hide();
                        $modal.modal('show');
                    };
                    var reader;
                    var file = '';
                    var url;

                    if (files && files.length > 0) {
                        file = files[0];

                        if (URL) {
                            done(URL.createObjectURL(file));
                        } else if (FileReader) {
                            reader = new FileReader();
                            reader.onload = function (e) {
                                done(reader.result);
                            };
                            reader.readAsDataURL(file);
                        }
                    }
                };

                $modal.on('shown.bs.modal', function () {
                    cropper = new Cropper(image, {
                        aspectRatio: 1,
                        viewMode: 1
                    });

                }).on('hidden.bs.modal', function () {
                    cropper.destroy();
                    cropper = null;
                });
                document.getElementById('crop').addEventListener('click', function () {

                    var canvas;

                    $modal.modal('hide');

                    if (cropper) {
                        let files, file, reader, img, ctx;
                        canvas = cropper.getCroppedCanvas({
                            width: 900,
                            height: 900,
                        });
                        initialAvatarURL = checkActiveCrop.src;
                        checkActiveCrop.src = canvas.toDataURL();
                        $progress.show();
                        $alert.removeClass('alert-success alert-warning');

                        canvas.toBlob(function (blob) {
                            //   console.log('blob==>', blob)
                            // form_Data.append(nameImage, blob, 'avatar.jpg');
                            files = [...form_Data];
                            
                             new Compressor(blob, {
                                quality: 0.6,
                                maxWidth: 900,
                                maxHeight: 900,
                                convertSize: 5000,
                                success(result) {
                                    //   // console.log('result=====>', result)
                                    var reader = new FileReader();
                                    reader.readAsDataURL(result);
                                    reader.onloadend = function () {
                                        var base64data = reader.result;
                                        //   // console.log('base64data=====>', base64data)
                                        checkActiveCrop.src = base64data;
                                        // $('#avatar').val(base64data);
                                        form_Data.append(nameImage, result, 'avatar.jpg');
                                        files = [...form_Data];
                                    }
                                },
                            });
                            //   console.log('filessssssssssssssssssssssssssss==>', files)
                            //   resize('shopImageMedium',files,600,'avatarMedium');
                            //   resize('shopImageSmall',files,300,'avatarSmall');
                            //   resize('shopImageVerySmall',files,50,'avatarVerySmall');
                        });
                    }
                });
            });

            function resize(fileName, files, size, imageName) {
                var resize_width = size;//without px

                //get the image selected
                var item = files[0][1];
                //create a FileReader
                var reader = new FileReader();

                //image turned to base64-encoded Data URI.
                reader.readAsDataURL(item);
                reader.name = item.name;//get the image's name
                reader.size = item.size; //get the image's size
                reader.onload = function (event) {
                    var img = new Image();//create a image
                    img.src = event.target.result;//result is base64-encoded Data URI
                    img.name = event.target.name;//set name (optional)
                    img.size = event.target.size;//set size (optional)
                    img.onload = function (el) {
                        var elem = document.createElement('canvas');//create a canvas

                        //scale the image to 600 (width) and keep aspect ratio
                        var scaleFactor = resize_width / el.target.width;
                        elem.width = resize_width;
                        elem.height = el.target.height * scaleFactor;
                        //draw in canvas
                        var ctx = elem.getContext('2d');
                        ctx.drawImage(el.target, 0, 0, elem.width, elem.height);
                        //get the base64-encoded Data URI from the resize image
                        var srcEncoded = ctx.canvas.toDataURL(el.target, 'image/jpeg', 0);
                        //assign it to thumb src
                        document.querySelector('#image').src = srcEncoded;

                        fetch(srcEncoded)
                            .then(res => res.blob())
                            .then((res2) => {
                                form_Data.append(fileName, res2, imageName + '.png');
                                files = [...form_Data];
                                // console.log('ffffffffffffffffffffff==>', files)
                            })
                    }
                }
            }

    var $progress;
            var $progressBar;
            var $alert;
            var initialAvatarURL;
            var formData = new FormData();
            window.addEventListener('DOMContentLoaded', function () {
                var avatar = document.getElementById('avatar2');
                var image = document.getElementById('image2');
                var input = document.getElementById('input2');
                //   $progress = $('.progress');
                //   $progressBar = $('.progress-bar');
                $alert = $('.cropper-alert');
                var $modal = $('#modal2');
                var cropper;

                $('[data-toggle="tooltip"]').tooltip();

                input.addEventListener('change', function (e) {
                    var files = e.target.files;
                    var done = function (url) {
                        input.value = '';
                        image.src = url;
                        $alert.hide();
                        $modal.modal('show');
                    };
                    var reader;
                    var file;
                    var url;

                    if (files && files.length > 0) {
                        file = files[0];

                        if (URL) {
                            done(URL.createObjectURL(file));
                        } else if (FileReader) {
                            reader = new FileReader();
                            reader.onload = function (e) {
                                done(reader.result);
                            };
                            reader.readAsDataURL(file);
                        }
                    }
                });

                $modal.on('shown.bs.modal', function () {
                    cropper = new Cropper(image, {
                        aspectRatio: 129 / 40,
                        viewMode: 3,
                    });
                }).on('hidden.bs.modal', function () {
                    cropper.destroy();
                    cropper = null;
                });
                document.getElementById('crop2').addEventListener('click', function (e) {
                    e.preventDefault();
                    var initialAvatarURL;
                    var canvas = document.createElement('canvas');


                    $("#loaderDiv3").show();
                    $("#input2").prop('disabled', true);
                    $("#avatar2").fadeTo('fast', 0.3);
                    $("#label-of-gallery").css('cursor', 'default');

                    if (cropper) {
                        canvas = cropper.getCroppedCanvas({
                            width: 1032,
                            height: 320,
                        });
                        $modal.modal('hide');




                        initialAvatarURL = avatar.src;
                        //   avatar.src = canvas.toDataURL();
                        //  $progress.show();
                        $alert.removeClass('alert-success alert-warning');
                        canvas.toBlob(function (blob) {
                            //   console.log('blob', blob)
                            new Compressor(blob, {
                                quality: 0.6,
                                maxWidth: 900,
                                maxHeight: 900,
                                convertSize: 5000,
                                success(result) {
                                    // console.log('result=====>', result)
                                    var reader = new FileReader();
                                    reader.readAsDataURL(result);
                                    reader.onloadend = function () {
                                        var base64data = reader.result;
                                        // console.log('base64data=====>', base64data)
                                        // checkActiveCrop.src = base64data;
                                        // $('#avatar').val(base64data);
                                        formData.append('gallery_image', result, 'avatar.jpg');
                                        formData.append('shop_id', ShopID);
                                    }
                                },
                            });
                            // formData.append('gallery_image', blob, 'avatar.jpg');

                            // formData.append('shop_id', ShopID);
                            var crf_token = $('input[name=csrfmiddlewaretoken]').val();
                            $(".progress-hide").show();
                            $.ajax(
                                {
                                    url: '{% url "restapi:web_shop_add_imagetogallery" %}',
                                    method: "post",
                                    data: formData,
                                    contentType: false,
                                    processData: false,
                                    headers: { "X-CSRFToken": crf_token },
                                    xhr: function () {
                                        var xhr = new XMLHttpRequest();
                                        xhr.upload.onprogress = function (e) {
                                            var percent = '0';
                                            var percentage = '0%';

                                            if (e.lengthComputable) {
                                                percent = Math.round((e.loaded / e.total) * 100);
                                                percentage = percent + '%';
                                                $(".progress-bar").width(percentage).attr('aria-valuenow', percent).text(percentage);
                                            }
                                        };

                                        return xhr;
                                    },
                                    success: function (json, status) {
                                        $("#input2").prop('disabled', false);
                                        $("#label-of-gallery").css('cursor', 'pointer');
                                        $("#avatar2").fadeTo('fast', 1);
                                        $(".progress-hide").hide();
                                        $(".progress-bar").width('0%').attr('aria-valuenow', 0).text('0%');
                                        $("#loaderDiv3").hide();
                                        if (json.status) {
                                            $(".product-gallery-pics").prepend('<div val="' + json.id + '" class="col-xl-6 prod-gallery-pic-box">' +
                                                '<div class="box-gallery-img-section gallery-img-show">' +
                                                '<img src="' + canvas.toDataURL() + '" alt="بنر حجره">' +
                                                '<div class="item-gallery-option">' +
                                                '<a href="' + json.image + '" id="show-image-gallery-product" title="مشاهده" target="_blank"><i class="fas fa-eye"></i></a>' +
                                                '<button val="' + json.id + '" class="delete-prod-pic" href="#" id="delete-image-gallery-product"  title="حذف"><i class="fas fa-minus-circle"></i></button>' +
                                                '</div>' +
                                                '</div>' +
                                                '</div>');
                                        }
                                        else {
                                            console.log(json.message);
                                        }
                                    },
                                    error: function (xhr, erstatus) {
                                        $(".progress-bar").width('0%').attr('aria-valuenow', 0).text('0%');
                                        $("#loaderDiv3").hide();
                                        $(".progress-hide").hide();
                                        $("#label-of-gallery").css('cursor', 'pointer');
                                        console.log(xhr);
                                        console.log(xhr.responseJSON);
                                        console.log(xhr.responseJSON.status);
                                        console.log(xhr.responseJSON.message);
                                        console.log(erstatus);
                                    }
                                }
                            )
                        });
                    }
                });
            });
    var profInfoajax = false;
    var submitResult = false;
    var submarkets_List = '';
    var holidaysString = '';
    

    checkProfileInfo = function () {
        $.ajax(
                {
                    type: 'GET',
                    url: '{% url "nakhll_market:check_user_profile_info" %}',

                    success: function (json) {
                        if (json.status) {
                            profInfoajax = true;
                            submitResult = clickOnEdit();
                            if (submitResult)
                            {
                                var crf_token = $('input[name=csrfmiddlewaretoken]').val();
                                
                                var shopTitle = $("#inputshop_title").val();
                                var shopDes = $("#inputshopdes").val();
                                var shopState = $("#inputshopState option:selected").text()
                                var shopBigCity = $("#inputshopBigCity option:selected").text()
                                var shopCity = $("#inputshopCity option:selected").text()
                                var shopBio = $("#inputshopBio").val();
                                var shopID = '{{UserShop.ID | safe }}';
                                
                                form_Data.append('shop_title' , shopTitle);
                                form_Data.append('shop_state' , shopState);
                                form_Data.append('shop_bigcity' , shopBigCity);
                                form_Data.append('shop_city' , shopCity);
                                form_Data.append('shop_des', shopDes);
                                form_Data.append('shop_bio', shopBio);
                                form_Data.append('shop_submarket', submarkets_List);
                                form_Data.append('shop_holidays', holidaysString);
                                form_Data.append('shop_id', shopID);
                                
                                $(".whole-prof-info-form").remove();
                                $(".whole-prof-info-body").html('<div class="please-wait"> لطفا منتظر بمانید <img src="{% static "images/loading.svg" %}" alt="در حال بارگذاری"> </div>' +
                                '<div class="progress"> ' +
                                '<div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>' +
                                '</div>' +
                                '<div class="inprogresstext"> در حال بارگزاری ...</div>');
                                $(".whole-prof-info-title").html('در حال ویرایش حجره...');
                                
                                $("#complete-info-modal").modal();
                                $.ajax(
                                        {
                                            url: '{% url "restapi:web_edit_shop" %}',
                                            method:"post",
                                            data: form_Data,
                                            contentType: false,
                                            processData: false,
                                            headers:{"X-CSRFToken": crf_token},
                                            xhr: function () {
                                                var xhr = new XMLHttpRequest();

                                                xhr.upload.onprogress = function (e) {
                                                var percent = '0';
                                                var percentage = '0%';

                                                if (e.lengthComputable) {
                                                    percent = Math.round((e.loaded / e.total) * 100);
                                                    percentage = percent + '%';
                                                    $(".progress-bar").width(percentage).attr('aria-valuenow', percent).text(percentage);
                                                }
                                                };

                                                return xhr;
                                            },
                                            success:function (json) {
                                                $(".whole-prof-info-title").html('ویرایش موفق حجره');
                                                $(".whole-prof-info-body").html('<div>حجره شما با موفقیت ویرایش گردید.</div>' +
                                                '<button type="button" class="btn btn-secondary float-left" data-dismiss="modal">بستن</button>' +
                                                '<a href="/profile/shops/"><button type="button" class="btn btn-primary float-left marginleft">مدیریت حجره</button></a>');
                                            },
                                            error:function (xhr, status) {
                                                $(".whole-prof-info-title").html('خطا در ویرایش حجره');
                                                $(".whole-prof-info-body").html('<div>ثبت حجره شما با خطا مواجه گردید.</div>' +
                                                '<div>' + xhr.responseJSON.res +' </div>' +
                                                '<button type="button" class="btn btn-secondary float-left" data-dismiss="modal">بستن</button>');
                                                $("#alert-div-system-error").show();
                                                console.log(xhr.status + ": " + xhr.responseText);
                                            }
                                        })
                            }
                        }
                        else if (json.msg == 'Information Is Not Complete'){
                            $("#complete-info-modal").modal();
                            profInfoajax = false;
                            $(".submit-shop-btn").removeClass("send-button-disabled disabled");
                        }
                        else {
                            $("#alert-div-system-error").show();
                            $(".submit-shop-btn").removeClass("send-button-disabled disabled");
                            profInfoajax = false;
                        }
                },
                    error: function (xhr) {
                        $("#alert-div-system-error").show();
                        console.log(xhr.status + ": " + xhr.responseText);
                    }
                }
            );
            return submitResult;
    }


    var usershopState = '{{UserShop.State | safe}}';
    var usershopBigCity = '{{UserShop.BigCity | safe}}';
    var usershopCity = '{{UserShop.City | safe}}';
    var findState = false;
    var findBigCity = false;
    var findCity = false;

    var shopStateOptions = $('#inputshopState option').map(function() { return ({'name': $(this).text(), 'id': $(this).val()})});
    var shopBigCityOptions = [];
    var shopCityOptions = [];
    $(document).ready(function() {
        for (var i=0; i < shopStateOptions.length; i++)
        {
            if (usershopState == shopStateOptions[i].name)
            {
                $("#inputshopState").val(shopStateOptions[i].id);
                $("#inputshopState").trigger('chosen:updated');
                selectedState = shopStateOptions[i].id;
                findState = true;
                createBigCity();
                break;
            }
        }
        
    })
</script>
<script src="{% static "js/shop/newShop.js" %}" type="text/javascript"></script>
<script src="{% static "js/factor/sendInfo.js" %}" type="text/javascript"></script>
<script>
    var userID = {{request.user.id | safe }};
    var checkValidForm = false;
    $("#send-profile-info-btn").on('click', function () {
    checkValidForm = checkLeftPart();
    if(checkValidForm)
    {
        $("#send-profile-info-btn").prop('disabled', true);
        $("#send-profile-info-btn").addClass('login-button-disabled');
        $.ajax(
                {
                    type: 'POST',
                    url: '{% url "nakhll_market:add_user_location_info" %}',
                    data: {
                        user_id: userID,
                        user_phonenumber: $("#inputPhoneNumber").val() ,
                        user_city_precode: $("#inputCityPerCode").val() ,
                        user_state: $("#inputprofState option:selected").text() ,
                        user_bigcity: $("#inputprofBigCity option:selected").text() ,
                        user_city: $("#inputprofCity option:selected").text() ,
                        user_address: $("#inputAddress").val() ,
                        user_zipcode: $("#inputZipCode").val() ,
                        csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
                        action: 'post'
                    },
                    success: function (json) {
                        $(".whole-prof-info-form").remove();
                        $(".whole-prof-info-body").html('<div> اطلاعات شما با موفقیت ثبت گردید.</div>' +
                        '<button type="button" class="btn btn-secondary float-left" data-dismiss="modal">بستن</button>');
                    },
                    error: function (xhr) {
                        $("#complete-info-modal").remove();
                        $("html, body").animate({ 
                            scrollTop: 120
                        }, "slow");
                        $("#alert-div-system-error").show();
                        console.log(xhr.status + ": " + xhr.responseText);
                    }
                }
            )
        }
    })

    createBigCityForProf = function ()
    {
        $.ajax (
            {
                type:'POST',
                url: '{% url "restapi:get_state_bigcity" %}',
                data: {
                    id: selectedProfState,
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                },
                success: function (json) {
                    $('#inputprofBigCity').empty(); //remove all child nodes
                    $('#inputprofBigCity').append('<option value="0">شهرستان خود را انتخاب نمائید...</option>');
                    for( i=0; i < json.length; i++) {
                        $("#inputprofBigCity").append('<option value="'+ json[i].id + '">' + json[i].name + '</option>');
                    }
                    $("#inputprofBigCity").trigger("chosen:updated");
                    if (findProfState)
                    {
                        profBigCityOptions = $('#inputprofBigCity option').map(function() { return ({'name': $(this).text(), 'id': $(this).val()})});
                        for(var i=0;i < profBigCityOptions.length; i++)
                        {
                            if (userprofBigCity == profBigCityOptions[i].name)
                            {
                                $("#inputprofBigCity").val(profBigCityOptions[i].id);
                                $("#inputprofBigCity").trigger('chosen:updated');
                                selectedProfBigCity = profBigCityOptions[i].id;
                                findBigCity = true;
                                createCityForProf();
                                break;
                            }
                        }
                    }
                },
                error: function () {
                    
                }
            }
        )
    }
    createCityForProf = function ()
    {
        $.ajax (
            {
                type:'POST',
                url: '{% url "restapi:get_bigcity_city" %}',
                data: {
                    id: selectedProfBigCity,
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                },
                success: function (json) {
                    $('#inputprofCity').empty(); //remove all child nodes
                    $('#inputprofCity').append('<option value="0">شهر خود را انتخاب نمائید...</option>');
                    for( i=0; i < json.length; i++) {
                        $("#inputprofCity").append('<option value="'+ json[i].id + '">' + json[i].name + '</option>');
                    }
                    $("#inputprofCity").trigger("chosen:updated");
                    if (findProfBigCity)
                    {
                        profCityOptions = $('#inputprofCity option').map(function() { return ({'name': $(this).text(), 'id': $(this).val()})});
                        for(var i=0;i < profCityOptions.length; i++)
                        {
                            if (userprofCity == profCityOptions[i].name)
                            {
                                $("#inputprofCity").val(profCityOptions[i].id);
                                $("#inputprofCity").trigger('chosen:updated');
                                break;
                            }
                        }
                    }
            },
            error: function () {
                
            }
        }
        )
    }
    var userprofState = '{{request.user.User_Profile.State}}';
    var userprofBigCity = '{{request.user.User_Profile.BigCity}}';
    var userprofCity = '{{request.user.User_Profile.City}}';
    var selectedProfState;
    var selectedProfBigCity;
    // var selectedProfCity;
    var findProfState = false;
    var findProfBigCity = false;
    var findProfCity = false;

    var profStateOptions = $('#inputprofState option').map(function() { return ({'name': $(this).text(), 'id': $(this).val()})});
    var profBigCityOptions = [];
    var profCityOptions = [];
    $(document).ready(function() {
        for (var i=0; i < profStateOptions.length; i++)
        {
            if (userprofState == profStateOptions[i].name)
            {
                $("#inputprofState").val(profStateOptions[i].id);
                $("#inputprofState").trigger('chosen:updated');
                selectedProfState = profStateOptions[i].id;
                findProfState = true;
                createBigCityForProf();
                break;
            }
        }
    })
</script>
<!-- multi image uploader :  -->
<script>

    var $progress;
    var $progressBar;
    var $alert;
    var initialAvatarURL;
    var form_Data = new FormData();
    window.addEventListener('DOMContentLoaded', function () {
        var avatar = document.getElementById('avatar');
        var image = document.getElementById('image');
        var input = document.getElementById('input');
        $progress = $('.progress');
        $progressBar = $('.progress-bar');
        $alert = $('.cropper-alert');
        var $modal = $('#modal');
        var cropper;

        $('[data-toggle="tooltip"]').tooltip();

        input.addEventListener('change', function (e) {
            var files = e.target.files;
            var done = function (url) {
                input.value = '';
                image.src = url;
                $alert.hide();
                $modal.modal('show');
            };
            var reader;
            var file;
            var url;

            if (files && files.length > 0) {
                file = files[0];

                if (URL) {
                    done(URL.createObjectURL(file));
                } else if (FileReader) {
                    reader = new FileReader();
                    reader.onload = function (e) {
                        done(reader.result);
                    };
                    reader.readAsDataURL(file);
                }
            }
        });

        $modal.on('shown.bs.modal', function () {
            cropper = new Cropper(image, {
                aspectRatio: 1,
                viewMode: 3,
            });
        }).on('hidden.bs.modal', function () {
            cropper.destroy();
            cropper = null;
        });
        document.getElementById('crop').addEventListener('click', function () {
            // var initialAvatarURL;
            var canvas;

            $modal.modal('hide');
            if (cropper) {
                canvas = cropper.getCroppedCanvas({
                    width: 900,
                    height: 900,
                });
                initialAvatarURL = avatar.src;
                avatar.src = canvas.toDataURL();
                $progress.show();
                $alert.removeClass('alert-success alert-warning');
                canvas.toBlob(function (blob) {
                    form_Data.append('product_image', blob, 'avatar.jpg');
                });
            }
        });
    });

    var $progress;
    var $progressBar;
    var $alert;
    var initialAvatarURL;
    var formData;
    window.addEventListener('DOMContentLoaded', function () {

        var avatar = document.getElementById('avatar3');
        var image = document.getElementById('image3');
        var input = document.getElementById('input3');
        //   $progress = $('.progress');
        //   $progressBar = $('.progress-bar');
        $alert = $('.cropper-alert');
        var $modal = $('#modal2');
        var cropper;

        $('[data-toggle="tooltip"]').tooltip();

        input.addEventListener('change', function (e) {
            var files = e.target.files;
            var done = function (url) {
                input.value = '';
                image.src = url;
                $alert.hide();
                $modal.modal('show');
            };
            var reader;
            var file;
            var url;

            if (files && files.length > 0) {
                file = files[0];

                if (URL) {
                    done(URL.createObjectURL(file));
                } else if (FileReader) {
                    reader = new FileReader();
                    reader.onload = function (e) {
                        done(reader.result);
                    };
                    reader.readAsDataURL(file);
                }
            }
        });

        $modal.on('shown.bs.modal', function () {
            cropper = new Cropper(image, {
                aspectRatio: 1,
                viewMode: 3,
            });
        }).on('hidden.bs.modal', function () {
            cropper.destroy();
            cropper = null;
        });
        document.getElementById('crop3').addEventListener('click', function (e) {
            e.preventDefault();
            formData = new FormData();
            $modal.modal('hide');
            var initialAvatarURL;
            var canvas;
            // crop2
            // console.log('#label-of-gallery', $("#label-of-gallery"))
            // debugger;
            $("#loaderDiv3").show();
            $("#input3").prop('disabled', true);
            $("#avatar3").fadeTo('fast', 0.3);
            $("#label-of-gallery").css('cursor', 'default');

            if (cropper) {
                canvas = cropper.getCroppedCanvas({
                    width: 900,
                    height: 900,
                });

                function uuidv4() {
                    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                        return v.toString(16);
                    });
                }

                initialAvatarURL = avatar.src;
                //   avatar.src = canvas.toDataURL();
                //  $progress.show();
                $alert.removeClass('alert-success alert-warning');
                canvas.toBlob(function (blob) {
                    // console.log('blob-criop2==>', blob);
                    new Compressor(blob, {
                        quality: 0.6,
                        maxWidth: 900,
                        maxHeight: 900,
                        convertSize: 5000,
                        success(result) {
                            // console.log('result=====>', result)
                            var reader = new FileReader();
                            reader.readAsDataURL(result);
                            reader.onloadend = () => {
                                var base64data = reader.result;
                                // console.log('base64data=====>', base64data)
                                // checkActiveCrop.src = base64data;
                                // $('#avatar').val(base64data);
                                formData.append('gallery_image', result, 'avatar.jpg');
                                formData.append('product_id', uuidv4());
                            }
                        },
                    });
                    
                    // formData.append('gallery_image', blob, 'avatar.jpg');

                    // formData.append('product_id', uuidv4());
                    var crf_token = $('input[name=csrfmiddlewaretoken]').val();
                    $(".progress-hide").show();
                    // progress=> hide
                    // debugger;
                    // console.log('formData==>', [...formData]);
                    $.ajax(
                        {
                            url: '{% url "restapi:web_product_add_imagetogallery" %}',
                            method: "post",
                            data: formData,
                            contentType: false,
                            processData: false,
                            headers: { "X-CSRFToken": crf_token },
                            xhr: function () {
                                var xhr = new XMLHttpRequest();
                                xhr.upload.onprogress = function (e) {
                                    var percent = '0';
                                    var percentage = '0%';

                                    if (e.lengthComputable) {
                                        percent = Math.round((e.loaded / e.total) * 100);
                                        percentage = percent + '%';
                                        $(".progress-bar").width(percentage).attr('aria-valuenow', percent).text(percentage);
                                    }
                                };

                                return xhr;
                            },
                            success: function (json, status) {
                                //success
                                console.log('json.message', json);
                                $("#input3").prop('disabled', false);
                                $("#label-of-gallery").css('cursor', 'pointer');
                                $("#avatar3").fadeTo('fast', 1);
                                $(".progress-hide").hide();
                                $(".progress-bar").width('0%').attr('aria-valuenow', 0).text('0%');
                                $("#loaderDiv3").hide();
                                if (json.status) {
                                    $(".product-gallery-pics").prepend('<div val="' + json.id + '" class="col-xl-3 prod-gallery-pic-box">' +
                                        '<div class="box-gallery-img-section gallery-img-show">' +
                                        '<img src="' + canvas.toDataURL() + '" alt="عکس محصول">' +
                                        '<div class="item-gallery-option">' +
                                        '<a href="' + json.image + '" id="show-image-gallery-product" title="مشاهده" target="_blank"><i class="fas fa-eye"></i></a>' +
                                        '<button val="' + json.id + '" class="delete-prod-pic" href="#" id="delete-image-gallery-product"  title="حذف"><i class="fas fa-minus-circle"></i></button>' +
                                        '</div>' +
                                        '</div>' +
                                        '</div>');
                                }
                                else {
                                    console.log('json.message', json.message);
                                }
                            },
                            error: function (xhr, erstatus) {
                                // formData = '';
                                $("#input3").prop('disabled', false);
                                $(".progress-bar").width('0%').attr('aria-valuenow', 0).text('0%');
                                $("#loaderDiv3").hide();
                                $(".progress-hide").hide();
                                $("#label-of-gallery").css('cursor', 'pointer');
                                console.log(xhr);
                                console.log(xhr.responseJSON);
                                console.log(xhr.responseJSON.status);
                                console.log(xhr.responseJSON.message);
                                console.log(erstatus);
                            }
                        }
                    )
                });
            }
        });
    });

</script>

{% block footer-section %}
    {% include "nakhll_market/parents/footer-section.html" %}
{% endblock %}

{% block footer %}
    {% include "nakhll_market/parents/footersite.html" %}
{% endblock %}      